<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
        }
        canvas {
            border: 2px solid #FFF;
            width: 90%; /* Adjust as needed */
            max-width: 800px; /* Maximum width of 800 pixels */
            height: auto; /* Maintain aspect ratio */
        }
        #score1, #score2 {
            color: #FFF;
            position: absolute;
            top: 10px;
        }
        #score1 {
            left: 10px;
        }
        #score2 {
            right: 10px;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- You might want to include your static files here -->
</head>
<body>
    <div class="container">
        {% block content %}
        {% if user.is_authenticated %}
        Hi {{ user.username }}!
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit">logout</button>
        </form>
        {% else %}
        <p>You are not logged in</p>
        <a href="{% url 'login' %}">Log In</a> |
        <a href="{% url 'signup' %}">Sign Up</a>
        {% endif %}
        {% endblock %}
        <h1 id="score1">Score: 0</h1>
        <h1 id="score2">Score: 0</h1>
        <canvas id="pongCanvas" width="800" height="400"></canvas>
    </div>
    {% comment %} <script src="/static/pong.js"></script> {% endcomment %}
    {{ room_name|json_script:"room-name" }}
    {{ users|json_script:"username" }}
    <script>
        const canvas = document.getElementById('pongCanvas');
        const context = canvas.getContext('2d');
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const users = JSON.parse(document.getElementById('username').textContent);
        console.log("user", users)
        {% comment %} const WS_ENDPOINT = 'ws://127.0.0.1:8000/ws/game/'; {% endcomment %}
        let ws = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/pong/'
            + roomName
            + '/'
        );

        // Define constants for the game
        const PADDLE_WIDTH = 10;
        const PADDLE_HEIGHT = 100;
        const BALL_RADIUS = 5;

        // Initialize paddle positions
        let playerPaddleY = canvas.height / 2 - PADDLE_HEIGHT / 2;
        let opponentPaddleY = canvas.height / 2 - PADDLE_HEIGHT / 2;
        let ballX = canvas.width / 2;
        let ballY = canvas.height / 2;

        // Track whether arrow keys are currently pressed
        let arrowUpPressed = false;
        let arrowDownPressed = false;
        
        canvas.addEventListener('touchstart', handleTouchStart, false);
        canvas.addEventListener('touchend', handleTouchEnd, false); 

        function handleTouchStart(event) {
            event.preventDefault();
            var touchY = event.touches[0].clientY;
            var canvasOffsetTop = canvas.getBoundingClientRect().top;
    
    // Subtract the offset to get the relative touchY position
            touchY -= canvasOffsetTop;
            console.log(touchY)
        // Determine if the touch event is above or below the paddle
            if (touchY < playerPaddleY + PADDLE_HEIGHT / 2) {
                // Move the paddle up
                arrowUpPressed = true;
            } else {
                // Move the paddle down
                arrowDownPressed = true;
            }
        }

        // Function to handle touch end event
        function handleTouchEnd(event) {
            event.preventDefault();
            // Reset arrow key states
            arrowUpPressed = false;
            arrowDownPressed = false;
        }
        // Event listener for keydown events
        document.addEventListener('keydown', function(event) {
            console.log('keydown', event.key);
            if (event.key === 'ArrowUp') {
                arrowUpPressed = true;
            } else if (event.key === 'ArrowDown') {
                arrowDownPressed = true;
            }
        });

        // Event listener for keyup events
        document.addEventListener('keyup', function(event) {
            console.log('keyup', event.key);
            if (event.key === 'ArrowUp') {
                arrowUpPressed = false;
            } else if (event.key === 'ArrowDown') {
                arrowDownPressed = false;
            }
        });

        // Event listener for keydown events
        // document.addEventListener('keydown', function(event) {
        //     if (event.key === 'ArrowUp') {
        //         // Send a message to the server indicating the user wants to move the paddle up
        //         console.log('sending move_up');
        //         ws.send(JSON.stringify({'action': 'move_up'}));
        //     } else if (event.key === 'ArrowDown') {
        //         // Send a message to the server indicating the user wants to move the paddle down
        //         ws.send(JSON.stringify({'action': 'move_down'}));
        //     }
        //     else if (event.key === 'Enter') {
        //         console.log('sending start_game');
        //         // Send a message to the server indicating the user wants to start the game
        //         ws.send(JSON.stringify({'action': 'start_game'}));
        //     }
        // });


        // Function to update paddle position
        function updatePaddlePosition() {
            if (arrowUpPressed) {
                console.log('sending move_up');
                ws.send(JSON.stringify({'action': 'move_up', 'user': users}));
            }
            if (arrowDownPressed) {
                ws.send(JSON.stringify({'action': 'move_down', 'user': users}));
            }
        }

        // Function to draw the paddles
        function drawPaddles() {
            // Clear the previous frame
            context.clearRect(0, 0, canvas.width, canvas.height);

            // Draw player paddle
            context.fillStyle = '#FFFFFF';
            context.fillRect(0, playerPaddleY, PADDLE_WIDTH, PADDLE_HEIGHT);

            // Draw opponent paddle
            context.fillRect(canvas.width - PADDLE_WIDTH, opponentPaddleY, PADDLE_WIDTH, PADDLE_HEIGHT);

            // Draw the ball
            context.beginPath();
            context.arc(ballX, ballY, BALL_RADIUS, 0, Math.PI * 2);
            context.fillStyle = '#FFFFFF';
            context.fill();
            context.closePath();
        }

        // Event listener for incoming messages from the server
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            // +console.log('received message');
            // console.log(data)
            // Update the opponent's paddle position based on data received from the server
            if (data.paddle2_y !== undefined) {
                opponentPaddleY = data.paddle2_y;
            }
            if (data.ball_x !== undefined) {
                ballX = data.ball_x;
            }
            if (data.ball_y !== undefined) {
                ballY = data.ball_y;
            }
            if (data.paddle1_y !== undefined) {
                playerPaddleY = data.paddle1_y;
                // console.log('playerPaddleY', playerPaddleY);
            }
            if (data.score1 !== undefined) {
                document.getElementById("score1").innerHTML = "Score: " + data.score1;
            }
            if (data.score2 !== undefined) {
                document.getElementById("score2").innerHTML = "Score: " + data.score2;
            }
            // Redraw the paddles and ball
            drawPaddles();
            updatePaddlePosition();
        };

        // Initial drawing of the paddles and ball
        drawPaddles();
</script>
</body>
</html>